<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
    <link rel="stylesheet" th:href="@{/css/header-style.css}"/>
    <link rel="stylesheet" th:href="@{/css/edit-property.css}"/>

    <title>Edit Property</title>

    <script>

        function previewNewImages(event) {
            const files = event.target.files;
            const container = document.getElementById('new-image-preview-container');
            container.innerHTML = ''; // Clear previous previews

            if (!files.length) {
                container.textContent = 'No new images selected.';
                return;
            }

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imgElement = document.createElement('img');
                    imgElement.src = e.target.result;
                    imgElement.style.maxWidth = '120px';
                    imgElement.style.margin = '8px';
                    container.appendChild(imgElement);
                };
                reader.readAsDataURL(file);
            }
        }

    </script>

</head>

<body>

<div th:replace="~{fragments :: header}"></div>

<div class="page-content-wrapper">
    <div class="card-container">

        <h2>Edit Property</h2>

        <div th:if="${successMessage}" class="success-message">
            <p th:text="${successMessage}"></p>
        </div>
        <div th:if="${errorMessage}" class="failure-message">
            <p th:text="${errorMessage}"></p>
        </div>
        <div th:if="${error}" class="failure-message">
            <p th:text="${error}"></p>
        </div>

        <form th:action="@{/properties/edit/{id}(id=${propertyId})}" method="post" th:object="${addPropertyDto}"
              enctype="multipart/form-data">

            <div th:if="${#fields.hasErrors('global')}">
                <p th:each="err : ${#fields.errors('global')}" th:text="${err}"></p>
            </div>
            <input type="hidden" name="propertyId" th:value="${propertyId}"/>
            <div>
                <label for="title">Title:</label>
                <input type="text" id="title" th:field="*{title}" required/>
                <div th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
            </div>

            <div>
                <label for="price">Price:</label>
                <input type="number" id="price" th:field="*{price}" step="0.01" required/>
                <div th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></div>
            </div>

            <div>
                <label for="location">Location:</label>
                <input type="text" id="location" th:field="*{location}" required/>
                <div th:if="${#fields.hasErrors('location')}" th:errors="*{location}"></div>
            </div>

            <div>
                <label for="zipCode">Zip Code:</label>
                <input type="text" id="zipCode" maxlength="5" th:field="*{zipCode}" required/>
                <div th:if="${#fields.hasErrors('zipCode')}" th:errors="*{zipCode}"></div>
            </div>

            <div>
                <label for="size">Size (sq ft):</label>
                <input type="number" id="size" th:field="*{size}" required/>
                <div th:if="${#fields.hasErrors('size')}" th:errors="*{size}"></div>
            </div>

            <div>
                <label for="description">Description:</label>
                <textarea id="description" th:field="*{description}" rows="4" cols="50"></textarea>
                <div th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
            </div>

            <div>
                <label for="newImages">Upload New Images:</label>
                <input type="file" id="newImages" name="newImages" multiple accept="image/*"
                       onchange="previewNewImages(event)"/>
            </div>

            <div id="new-image-preview-container">
                No new images selected.
            </div>

            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a th:href="@{/properties/manage}" class="btn">Back to Manage Properties</a>
        </form>
        <hr/>

        <h3>Existing Property Images:</h3>
        <div id="existing-images-gallery">
            <div th:if="${property.images != null and !property.images.empty}">
                <div th:each="image : ${property.images}">
                    <img style="width: 150px;"
                         th:src="@{/images/uploads/{id}/{filename}(id=${property.id}, filename=${image.imageFilename})}"
                         th:alt="${'Image of ' + property.title}"/>
                    <div>
                        <form
                                th:action="@{/properties/{propertyId}/images/{imageId}/delete(propertyId=${property.id}, imageId=${image.id})}"
                                method="post" onsubmit="return confirm('Are you sure you want to delete this image?');">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
            <div th:unless="${property.images != null and !property.images.empty}">
                <p>No existing images.</p>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{fragments :: footer}"></div>


</body>

</html>